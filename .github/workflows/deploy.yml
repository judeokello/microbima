name: Deploy to Fly.io

on:
  push:
    branches:
      - staging
      - master
  pull_request:
    branches:
      - staging
      - master

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }} 

jobs:
  deploy-staging:
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    env:
      DEPLOY_INTERNAL_API: true
      AUTO_DEPLOY_DB: true
      DEPLOY_AGENT_REGISTRATION: true
      DEPLOY_PUBLIC_API: false
      RUN_TESTS: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        env:
          PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING: 1
        run: pnpm install --frozen-lockfile

      - name: Run tests
        if: env.RUN_TESTS != 'false'
        run: pnpm test

      - name: Install Fly.io CLI
        run: |
          curl -L https://fly.io/install.sh | sh
          echo "$HOME/.fly/bin" >> $GITHUB_PATH
          export PATH="$HOME/.fly/bin:$PATH"
          flyctl version

      - name: Deploy Internal API to Staging
        if: env.DEPLOY_INTERNAL_API != 'false'
        run: |
          # Retry deployment up to 3 times on failure
          for i in {1..3}; do
            echo "Deployment attempt $i..."
            if flyctl deploy -a maishapoa-staging-internal-api -c infra/fly/internal-api/staging/fly.toml; then
              echo "‚úÖ Deployment successful"
              break
            else
              if [ $i -lt 3 ]; then
                echo "‚ö†Ô∏è Deployment failed, retrying in 30 seconds..."
                sleep 30
              else
                echo "‚ùå Deployment failed after 3 attempts"
                exit 1
              fi
            fi
          done

      - name: Run Database Migrations on Staging
        if: env.DEPLOY_INTERNAL_API != 'false' && env.AUTO_DEPLOY_DB == 'true'
        run: |
          echo "üîÑ Running database migrations on staging..."
          
          # Proactively resolve known failed migration in staging (idempotent)
          # This ensures staging can always proceed, even if status check fails
          echo "üîß Proactively resolving any failed migrations in staging..."
          
          # First, ensure PENDING_ACTIVATION enum value exists (idempotent)
          echo "üìù Adding PENDING_ACTIVATION enum value if missing..."
          set +e  # Don't fail if enum already exists (IF NOT EXISTS handles this)
          ENUM_RESULT=$(flyctl ssh console -a maishapoa-staging-internal-api -C "sh -c 'cd /app/apps/api && echo \"ALTER TYPE \\\"public\\\".\\\"PolicyStatus\\\" ADD VALUE IF NOT EXISTS '\''PENDING_ACTIVATION'\'';\" | npx prisma db execute --stdin --schema prisma/schema.prisma 2>&1'")
          ENUM_EXIT_CODE=$?
          set -e
          
          # Log result but don't fail if it's just "already exists" or similar
          echo "Enum addition result (exit code: $ENUM_EXIT_CODE):"
          echo "$ENUM_RESULT"
          
          # Mark the failed migration as rolled back (idempotent - safe if already resolved)
          echo "üîÑ Resolving failed migration if it exists..."
          set +e  # Don't fail if migration is already resolved or doesn't exist
          flyctl ssh console -a maishapoa-staging-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate resolve --rolled-back 20251030180217_add_package_plans_and_policy_payments'"
          set -e
          
          # Mark the enum migration as applied if it exists (idempotent)
          echo "üìã Marking enum migration as applied if it exists..."
          set +e  # Don't fail if migration doesn't exist
          flyctl ssh console -a maishapoa-staging-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate resolve --applied 20251030180216_add_pending_activation_enum 2>/dev/null || true'"
          set -e
          
          # Verify DIRECT_URL is configured (critical for migration performance)
          echo "üîç Verifying DIRECT_URL is configured for fast migrations..."
          echo "üí° Note: Without DIRECT_URL, migrations use pooled connection (30+ minutes). With DIRECT_URL: 5-10 minutes."
          echo "üìñ See: apps/api/docs/SUPABASE_MIGRATION_PERFORMANCE.md for setup instructions"
          
          # Check migration status first to see what needs to be applied
          echo "üìã Checking migration status before deployment..."
          set +e  # Don't fail if there are pending migrations (exit code 1 is expected)
          MIGRATION_STATUS=$(flyctl ssh console -a maishapoa-staging-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate status' 2>&1 || true")
          MIGRATION_EXIT_CODE=$?
          set -e
          
          # Show migration status (exit code 1 is normal when migrations are pending)
          echo "Migration status output (exit code $MIGRATION_EXIT_CODE):"
          echo "$MIGRATION_STATUS"
          
          # Now run migration deployment
          # Note: migrate deploy doesn't run seed scripts by default (only migrate dev does)
          # Large migrations (like init with 412 lines) can take 5-10+ minutes on Supabase with direct connection
          # Without DIRECT_URL, this can take 30+ minutes with pooled connection
          echo "üöÄ Deploying migrations..."
          echo "‚è±Ô∏è  Expected time: 5-10 minutes (direct) or 30+ minutes (pooled) for large migrations..."
          echo "üí° Tip: The init migration (412 lines) is particularly large"
          
          # Run migration with explicit query engine path for musl compatibility
          # Note: migrate deploy doesn't run seed scripts by default, so --skip-seed is not needed
          flyctl ssh console -a maishapoa-staging-internal-api -C "sh -c 'cd /app/apps/api && PRISMA_CLI_QUERY_ENGINE_LIBRARY=/app/node_modules/.prisma/client/libquery_engine-linux-musl-openssl-3.0.x.so.node npx prisma migrate deploy'"
          
          echo "‚úÖ Database migrations completed"

      - name: Create Root User on Staging (if needed)
        if: env.DEPLOY_INTERNAL_API != 'false' && env.AUTO_DEPLOY_DB == 'true'
        run: |
          echo "üë§ Checking if root user needs to be created..."
          flyctl ssh console -a maishapoa-staging-internal-api -C "sh -c 'cd /app/apps/api && node scripts/create-root-user.js'"
          echo "‚úÖ Root user check completed"

      - name: Seed Product Management Data on Staging
        if: env.DEPLOY_INTERNAL_API != 'false' && env.AUTO_DEPLOY_DB == 'true'
        run: |
          echo "üîÑ Updating Fly.io CLI to latest..."
          flyctl version upgrade || true
          flyctl version
          
          echo "üå± Seeding product management data on staging..."
          echo "üìù Running idempotent seed script (safe to run multiple times)..."
          flyctl ssh console -a maishapoa-staging-internal-api -C "sh -c 'cd /app/apps/api && npx prisma db execute --file prisma/seed-product-management.sql --schema prisma/schema.prisma'"
          echo "‚úÖ Product management data seeded"
          sleep 5
          
          # Migrate existing customers to package schemes (idempotent)
          echo "üîÑ Migrating existing customers to package schemes..."
          flyctl ssh console -a maishapoa-staging-internal-api -C "sh -c 'cd /app/apps/api && npx prisma db execute --file prisma/migrate-existing-customers.sql --schema prisma/schema.prisma'"
          echo "‚úÖ Existing customers migrated to package schemes"
          sleep 5
          
          # Seed policy number sequences for all packages (idempotent)
          echo "üî¢ Seeding policy number sequences..."
          flyctl ssh console -a maishapoa-staging-internal-api -C "sh -c 'cd /app/apps/api && npx prisma db execute --file prisma/seed-policy-number-sequence.sql --schema prisma/schema.prisma'"
          echo "‚úÖ Policy number sequences seeded"

          # Seed policy number sequences for all packages (idempotent)
          echo "üî¢ Seeding policy number sequences..."
          flyctl ssh console -a maishapoa-staging-internal-api -C "sh -c 'cd /app/apps/api && npx prisma db execute --file prisma/seed-policy-number-sequence.sql --schema prisma/schema.prisma'"
          echo "‚úÖ Policy number sequences seeded"

      - name: Deploy Agent Registration to Staging
        if: env.DEPLOY_AGENT_REGISTRATION != 'false'
        run: |
          # Retry deployment up to 3 times on failure
          for i in {1..3}; do
            echo "Deployment attempt $i..."
            if flyctl deploy -a maishapoa-staging-agent-registration -c infra/fly/agent-registration/staging/fly.toml; then
              echo "‚úÖ Deployment successful"
              break
            else
              if [ $i -lt 3 ]; then
                echo "‚ö†Ô∏è Deployment failed, retrying in 30 seconds..."
                sleep 30
              else
                echo "‚ùå Deployment failed after 3 attempts"
                exit 1
              fi
            fi
          done

      # TODO: Enable when web-admin app is created
      # - name: Deploy Web Admin to Staging
      #   run: |
      #     flyctl deploy -a microbima-staging-web-admin -c infra/fly/web-admin/staging/fly.toml

      - name: Deploy Public API to Staging
        if: env.DEPLOY_PUBLIC_API != 'false'
        run: |
          # Retry deployment up to 3 times on failure
          cd infra/fly/public-api/staging
          for i in {1..3}; do
            echo "Deployment attempt $i..."
            if flyctl deploy -a microbima-staging-public-api -c fly.toml; then
              echo "‚úÖ Deployment successful"
              break
            else
              if [ $i -lt 3 ]; then
                echo "‚ö†Ô∏è Deployment failed, retrying in 30 seconds..."
                sleep 30
              else
                echo "‚ùå Deployment failed after 3 attempts"
                exit 1
              fi
            fi
          done
          cd -

  deploy-production:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: https://maishapoa-production-internal-api.fly.dev
    env:
      DEPLOY_INTERNAL_API: true
      AUTO_DEPLOY_DB: true
      DEPLOY_AGENT_REGISTRATION: true
      DEPLOY_PUBLIC_API: false
      RUN_TESTS: true
     
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        env:
          PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING: 1
        run: pnpm install --frozen-lockfile

      - name: Run tests
        if: env.RUN_TESTS != 'false'
        run: pnpm test

      - name: Install Fly.io CLI
        run: |
          curl -L https://fly.io/install.sh | sh
          echo "$HOME/.fly/bin" >> $GITHUB_PATH
          export PATH="$HOME/.fly/bin:$PATH"
          flyctl version

      - name: Deploy Internal API to Production
        if: env.DEPLOY_INTERNAL_API != 'false'
        run: |
          # Retry deployment up to 3 times on failure
          for i in {1..3}; do
            echo "Deployment attempt $i..."
            if flyctl deploy -a maishapoa-production-internal-api -c infra/fly/internal-api/production/fly.toml; then
              echo "‚úÖ Deployment successful"
              break
            else
              if [ $i -lt 3 ]; then
                echo "‚ö†Ô∏è Deployment failed, retrying in 30 seconds..."
                sleep 30
              else
                echo "‚ùå Deployment failed after 3 attempts"
                exit 1
              fi
            fi
          done

      - name: Run Database Migrations on Production
        if: env.DEPLOY_INTERNAL_API != 'false' && env.AUTO_DEPLOY_DB == 'true'
        run: |
          echo "üîÑ Running database migrations on production..."
          
          # First, check if schemes table exists (needed for tags migration)
          echo "üîç Checking if schemes table exists..."
          set +e
          SCHEMES_CHECK=$(flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && echo \"SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_schema = '\''public'\'' AND table_name = '\''schemes'\'');\" | npx prisma db execute --stdin --schema prisma/schema.prisma 2>&1'")
          set -e
          
          # Check migration status
          echo "üìä Checking migration status..."
          set +e
          # Capture both stdout and stderr, don't fail on error exit code
          MIGRATION_STATUS=$(flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate status' 2>&1 || true")
          MIGRATION_EXIT_CODE=0  # Reset since we're using || true
          set -e
          
          # Debug: show migration status
          echo "Migration status output:"
          echo "$MIGRATION_STATUS"
          
          # Proactively skip tags migration during migrate deploy (it has dependency issue)
          # Mark it as applied to prevent Prisma from trying to run it before schemes table exists
          echo "üîß Proactively skipping tags migration (will apply manually after schemes table exists)..."
          set +e
          # First resolve any failed/rolled-back state
          flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate resolve --rolled-back 20250202120000_add_tags_system 2>&1' || true"
          
          # Mark as applied to skip it during migrate deploy (safe because we'll manually apply it after)
          SKIP_OUTPUT=$(flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate resolve --applied 20250202120000_add_tags_system 2>&1'")
          SKIP_EXIT=$?
          set -e
          
          if [ "$SKIP_EXIT" -eq 0 ]; then
            echo "‚úÖ Tags migration marked as applied (will be skipped during migrate deploy)."
            echo "   It will be manually applied after schemes table is created by product management migration."
            TAGS_MIGRATION_SKIPPED=true
          else
            # If we can't mark it as applied, check if it's already applied or in a different state
            if echo "$SKIP_OUTPUT" | grep -q "already applied\|already marked"; then
              echo "‚ÑπÔ∏è Tags migration already marked as applied - will skip during migrate deploy."
              TAGS_MIGRATION_SKIPPED=true
            else
              echo "‚ö†Ô∏è Could not mark tags migration as applied: $SKIP_OUTPUT"
              echo "   Will attempt to proceed - may fail and need manual resolution."
              TAGS_MIGRATION_SKIPPED=false
            fi
          fi
          
          # Check for other failed migrations (P3009 error) - REQUIRE MANUAL INTERVENTION FOR PRODUCTION
          # But skip if it's only the tags migration (we handle that above)
          if echo "$MIGRATION_STATUS" | grep -q "failed migrations\|P3009\|P3018"; then
            # If we've skipped the tags migration, proceed with other migrations
            if [ "$TAGS_MIGRATION_SKIPPED" = "true" ]; then
              echo "‚úÖ Tags migration skipped, proceeding with other migrations..."
            else
              # Other failed migrations - require manual intervention
              echo "‚ö†Ô∏è Failed migrations detected in production."
              echo "‚ùå PRODUCTION SAFETY: Automated resolution is NOT available."
              echo "üìã Manual intervention REQUIRED before proceeding:"
              echo ""
              echo "   1. Connect to production:"
              echo "      flyctl ssh console -a maishapoa-production-internal-api"
              echo ""
              echo "   2. Check migration status:"
              echo "      cd /app/apps/api && npx prisma migrate status"
              echo ""
              echo "   3. Add missing enum value (if needed):"
              echo "      echo \"ALTER TYPE \\\"public\\\".\\\"PolicyStatus\\\" ADD VALUE IF NOT EXISTS 'PENDING_ACTIVATION';\" | npx prisma db execute --stdin --schema prisma/schema.prisma"
              echo ""
              echo "   4. Resolve failed migration:"
              echo "      npx prisma migrate resolve --rolled-back 20251030180217_add_package_plans_and_policy_payments"
              echo ""
              echo "   5. Mark enum migration as applied (if exists):"
              echo "      npx prisma migrate resolve --applied 20251030180216_add_pending_activation_enum 2>/dev/null || true"
              echo ""
              echo "   6. Verify status:"
              echo "      npx prisma migrate status"
              echo ""
              echo "   7. After manual resolution, retry deployment"
              echo ""
              exit 1
            fi
          elif echo "$MIGRATION_STATUS" | grep -q "drift"; then
            echo "‚ö†Ô∏è Drift detected in production."
            echo "‚ùå Automated drift resolution is not available for production safety."
            echo "üìã Manual intervention required:"
            echo "   1. Connect to production: flyctl ssh console -a maishapoa-production-internal-api"
            echo "   2. Check status: cd /app/apps/api && npx prisma migrate status"
            echo "   3. Resolve drift: npx prisma migrate resolve --applied [migration-name]"
            echo "   4. Retry deployment"
            exit 1
          else
            echo "‚úÖ No issues detected, running normal migration..."
          fi
          
          # Run migration deployment
          echo "üöÄ Deploying migrations to production..."
          flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate deploy'"
          
          # After migrations, check if tags migration needs to be applied
          echo "üîç Checking if tags migration needs to be applied..."
          set +e
          SCHEMES_EXISTS=$(flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && echo \"SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_schema = '\''public'\'' AND table_name = '\''schemes'\'');\" | npx prisma db execute --stdin --schema prisma/schema.prisma 2>&1' | grep -o 'true\|false' | head -1")
          set -e
          
          if [ "$SCHEMES_EXISTS" = "true" ]; then
            echo "‚úÖ Schemes table exists. Checking if tags migration needs to be applied..."
            set +e
            TAGS_TABLE_EXISTS=$(flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && echo \"SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_schema = '\''public'\'' AND table_name = '\''tags'\'');\" | npx prisma db execute --stdin --schema prisma/schema.prisma 2>&1' | grep -o 'true\|false' | head -1")
            set -e
            
            if [ "$TAGS_TABLE_EXISTS" != "true" ]; then
              echo "üîß Applying tags migration now that schemes table exists..."
              set +e
              # Check if migration file exists first
              TAGS_MIGRATION_EXISTS=$(flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && test -f prisma/migrations/20250202120000_add_tags_system/migration.sql && echo \"exists\" || echo \"missing\"'")
              set -e
              
              if echo "$TAGS_MIGRATION_EXISTS" | grep -q "exists"; then
                # Apply the tags migration
                flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && cat prisma/migrations/20250202120000_add_tags_system/migration.sql | npx prisma db execute --stdin --schema prisma/schema.prisma'"
                
                # Mark migration as applied (idempotent - safe if already applied)
                set +e
                flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate resolve --applied 20250202120000_add_tags_system 2>/dev/null || true'"
                set -e
                echo "‚úÖ Tags migration applied and marked as resolved"
              else
                echo "‚ö†Ô∏è Tags migration file not found. Skipping automatic application."
              fi
            else
              echo "‚úÖ Tags table already exists, marking migration as applied..."
              flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate resolve --applied 20250202120000_add_tags_system 2>/dev/null || true'"
            fi
          fi
          
          echo "‚úÖ Database migrations completed"

      - name: Create Root User on Production (if needed)
        if: env.DEPLOY_INTERNAL_API != 'false' && env.AUTO_DEPLOY_DB == 'true'
        run: |
          echo "üë§ Checking if root user needs to be created..."
          flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && node scripts/create-root-user.js'"
          echo "‚úÖ Root user check completed"

      - name: Seed Product Management Data on Production
        if: env.DEPLOY_INTERNAL_API != 'false' && env.AUTO_DEPLOY_DB == 'true'
        run: |
          echo "üîÑ Updating Fly.io CLI to latest..."
          flyctl version upgrade || true
          flyctl version
          
          echo "üå± Seeding product management data on production..."
          echo "üìù Running idempotent seed script (safe to run multiple times)..."
          flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma db execute --file prisma/seed-product-management.sql --schema prisma/schema.prisma'"
          echo "‚úÖ Product management data seeded"
          sleep 5
          
          # Migrate existing customers to package schemes (idempotent)
          echo "üîÑ Migrating existing customers to package schemes..."
          flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma db execute --file prisma/migrate-existing-customers.sql --schema prisma/schema.prisma'"
          echo "‚úÖ Existing customers migrated to package schemes"
          sleep 5
          
          # Seed policy number sequences for all packages (idempotent)
          echo "üî¢ Seeding policy number sequences..."
          flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma db execute --file prisma/seed-policy-number-sequence.sql --schema prisma/schema.prisma'"
          echo "‚úÖ Policy number sequences seeded"

          # Seed policy number sequences for all packages (idempotent)
          echo "üî¢ Seeding policy number sequences..."
          flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma db execute --file prisma/seed-policy-number-sequence.sql --schema prisma/schema.prisma'"
          echo "‚úÖ Policy number sequences seeded"

      - name: Deploy Agent Registration to Production
        if: env.DEPLOY_AGENT_REGISTRATION != 'false'
        run: |
          # Retry deployment up to 3 times on failure
          for i in {1..3}; do
            echo "Deployment attempt $i..."
            if flyctl deploy -a maishapoa-production-agent-registration -c infra/fly/agent-registration/production/fly.toml; then
              echo "‚úÖ Deployment successful"
              break
            else
              if [ $i -lt 3 ]; then
                echo "‚ö†Ô∏è Deployment failed, retrying in 30 seconds..."
                sleep 30
              else
                echo "‚ùå Deployment failed after 3 attempts"
                exit 1
              fi
            fi
          done

      - name: Deploy Public API to Production
        if: env.DEPLOY_PUBLIC_API != 'false'
        run: |
          # Retry deployment up to 3 times on failure
          cd infra/fly/public-api/production
          for i in {1..3}; do
            echo "Deployment attempt $i..."
            if flyctl deploy -a maishapoa-production-public-api -c fly.toml; then
              echo "‚úÖ Deployment successful"
              break
            else
              if [ $i -lt 3 ]; then
                echo "‚ö†Ô∏è Deployment failed, retrying in 30 seconds..."
                sleep 30
              else
                echo "‚ùå Deployment failed after 3 attempts"
                exit 1
              fi
            fi
          done
          cd -

      # TODO: Enable when web-admin app is created
      # - name: Deploy Web Admin to Production
      #   run: |
      #     flyctl deploy -a maishapoa-production-web-admin -c infra/fly/web-admin/production/fly.toml

  health-check:
    needs: [deploy-staging, deploy-production]
    if: always()
    runs-on: ubuntu-latest
    env:
      DEPLOY_INTERNAL_API: true
      DEPLOY_PUBLIC_API: false
    steps:
      - name: Health Check Staging
        if: github.ref == 'refs/heads/staging'
        run: |
          echo "üè• Running health checks for Staging environment..."
          
          # Agent Registration App
          echo "Checking Agent Registration..."
          curl -f https://maishapoa-staging-agent-registration.fly.dev/ || exit 1
          echo "‚úÖ Agent Registration is healthy"
          
          # Internal API (conditional check)
          if [ "$DEPLOY_INTERNAL_API" != "false" ]; then
            echo "Checking Internal API..."
            curl -f https://maishapoa-staging-internal-api.fly.dev/health || echo "‚ö†Ô∏è Internal API health check failed"
          else
            echo "‚è≠Ô∏è Skipping Internal API health check (not deployed)"
          fi
          
          # Public API (Kong Gateway) - conditional check
          if [ "$DEPLOY_PUBLIC_API" != "false" ]; then
            echo "Checking Public API..."
            set +e  # Don't fail on curl errors initially
            STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 https://microbima-staging-public-api.fly.dev/api/v1/customers 2>/dev/null || echo "000")
            CURL_EXIT_CODE=$?
            set -e
            echo "Public API status: $STATUS_CODE"
            
            if [ "$STATUS_CODE" = "000" ] || [ "$CURL_EXIT_CODE" -ne 0 ]; then
              echo "‚ùå Public API is not reachable (service should be deployed but is not responding)"
              echo "   This indicates a deployment issue that needs attention."
              exit 1  # Fail the health check job
            elif [ "$STATUS_CODE" -eq "200" ] || [ "$STATUS_CODE" -eq "401" ] || [ "$STATUS_CODE" -eq "403" ]; then
              echo "‚úÖ Public API is healthy and proxying correctly"
            elif [ "$STATUS_CODE" -eq "502" ] || [ "$STATUS_CODE" -eq "503" ]; then
              echo "‚ö†Ô∏è Public API deployed but backend connection issues (status $STATUS_CODE)"
              echo "   This is expected if backend is not deployed. Kong is running."
            else
              echo "‚ö†Ô∏è Public API returned unexpected status: $STATUS_CODE"
              echo "   This may indicate a configuration issue."
            fi
          else
            echo "‚è≠Ô∏è Skipping Public API health check (not deployed)"
          fi
          
          # TODO: Add health check when web-admin app is deployed
          # curl -f https://microbima-staging-web-admin.fly.dev/ || exit 1
          
          echo "‚úÖ Staging health checks completed"

      - name: Health Check Production
        if: github.ref == 'refs/heads/master'
        run: |
          echo "üè• Running health checks for Production environment..."
          
          # Internal API
          echo "Checking Internal API..."
          curl -f https://maishapoa-production-internal-api.fly.dev/health || exit 1
          echo "‚úÖ Internal API is healthy"
          
          # Agent Registration App
          echo "Checking Agent Registration..."
          curl -f https://maishapoa-production-agent-registration.fly.dev/ || exit 1
          echo "‚úÖ Agent Registration is healthy"
          
          # Public API (Kong Gateway) - conditional check
          if [ "$DEPLOY_PUBLIC_API" != "false" ]; then
            echo "Checking Public API..."
            set +e  # Don't fail on curl errors initially
            STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 https://maishapoa-production-public-api.fly.dev/api/v1/customers 2>/dev/null || echo "000")
            CURL_EXIT_CODE=$?
            set -e
            echo "Public API status: $STATUS_CODE"
            
            if [ "$STATUS_CODE" = "000" ] || [ "$CURL_EXIT_CODE" -ne 0 ]; then
              echo "‚ùå Public API is not reachable (service should be deployed but is not responding)"
              echo "   This indicates a deployment issue that needs attention."
              exit 1  # Fail the health check job
            elif [ "$STATUS_CODE" -eq "200" ] || [ "$STATUS_CODE" -eq "401" ] || [ "$STATUS_CODE" -eq "403" ]; then
              echo "‚úÖ Public API is healthy and proxying correctly"
            elif [ "$STATUS_CODE" -eq "502" ] || [ "$STATUS_CODE" -eq "503" ]; then
              echo "‚ö†Ô∏è Public API deployed but backend connection issues (status $STATUS_CODE)"
              echo "   This is expected if backend is not deployed. Kong is running."
            else
              echo "‚ö†Ô∏è Public API returned unexpected status: $STATUS_CODE"
              echo "   This may indicate a configuration issue."
            fi
          else
            echo "‚è≠Ô∏è Skipping Public API health check (not deployed)"
          fi
          
          # TODO: Add health check when web-admin app is deployed
          # curl -f https://maishapoa-production-web-admin.fly.dev/ || exit 1
          
          echo "‚úÖ All production health checks passed successfully"
