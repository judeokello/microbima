name: Deploy to Fly.io

on:
  push:
    branches:
      - staging
      - master
  pull_request:
    branches:
      - staging
      - master

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }} 

jobs:
  deploy-staging:
    if: github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    env:
      DEPLOY_INTERNAL_API: true
      AUTO_DEPLOY_DB: true
      DEPLOY_AGENT_REGISTRATION: true
      DEPLOY_PUBLIC_API: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test

      - name: Install Fly.io CLI
        run: |
          curl -L https://fly.io/install.sh | sh
          echo "$HOME/.fly/bin" >> $GITHUB_PATH

      - name: Deploy Internal API to Staging
        if: env.DEPLOY_INTERNAL_API != 'false'
        run: |
          # Retry deployment up to 3 times on failure
          for i in {1..3}; do
            echo "Deployment attempt $i..."
            if flyctl deploy -a microbima-staging-internal-api -c infra/fly/internal-api/staging/fly.toml; then
              echo "‚úÖ Deployment successful"
              break
            else
              if [ $i -lt 3 ]; then
                echo "‚ö†Ô∏è Deployment failed, retrying in 30 seconds..."
                sleep 30
              else
                echo "‚ùå Deployment failed after 3 attempts"
                exit 1
              fi
            fi
          done

      - name: Run Database Migrations on Staging
        if: env.DEPLOY_INTERNAL_API != 'false' && env.AUTO_DEPLOY_DB == 'true'
        run: |
          echo "üîÑ Running database migrations on staging..."
          
          # Proactively resolve known failed migration in staging (idempotent)
          # This ensures staging can always proceed, even if status check fails
          echo "üîß Proactively resolving any failed migrations in staging..."
          
          # First, ensure PENDING_ACTIVATION enum value exists (idempotent)
          echo "üìù Adding PENDING_ACTIVATION enum value if missing..."
          set +e  # Don't fail if enum already exists (IF NOT EXISTS handles this)
          ENUM_RESULT=$(flyctl ssh console -a microbima-staging-internal-api -C "sh -c 'cd /app/apps/api && echo \"ALTER TYPE \\\"public\\\".\\\"PolicyStatus\\\" ADD VALUE IF NOT EXISTS '\''PENDING_ACTIVATION'\'';\" | npx prisma db execute --stdin --schema prisma/schema.prisma 2>&1'")
          ENUM_EXIT_CODE=$?
          set -e
          
          # Log result but don't fail if it's just "already exists" or similar
          echo "Enum addition result (exit code: $ENUM_EXIT_CODE):"
          echo "$ENUM_RESULT"
          
          # Mark the failed migration as rolled back (idempotent - safe if already resolved)
          echo "üîÑ Resolving failed migration if it exists..."
          set +e  # Don't fail if migration is already resolved or doesn't exist
          flyctl ssh console -a microbima-staging-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate resolve --rolled-back 20251030180217_add_package_plans_and_policy_payments'"
          set -e
          
          # Mark the enum migration as applied if it exists (idempotent)
          echo "üìã Marking enum migration as applied if it exists..."
          set +e  # Don't fail if migration doesn't exist
          flyctl ssh console -a microbima-staging-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate resolve --applied 20251030180216_add_pending_activation_enum 2>/dev/null || true'"
          set -e
          
          # Now run migration deployment
          echo "üöÄ Deploying migrations..."
          flyctl ssh console -a microbima-staging-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate deploy'"
          
          echo "‚úÖ Database migrations completed"

      - name: Seed Product Management Data on Staging
        if: env.DEPLOY_INTERNAL_API != 'false' && env.AUTO_DEPLOY_DB == 'true'
        run: |
          echo "üå± Seeding product management data on staging..."
          echo "üìù Running idempotent seed script (safe to run multiple times)..."
          flyctl ssh console -a microbima-staging-internal-api -C "sh -c 'cd /app/apps/api && npx prisma db execute --file prisma/seed-product-management.sql --schema prisma/schema.prisma'"
          echo "‚úÖ Product management data seeded"
          
          # Migrate existing customers to package schemes (idempotent)
          echo "üîÑ Migrating existing customers to package schemes..."
          flyctl ssh console -a microbima-staging-internal-api -C "sh -c 'cd /app/apps/api && npx prisma db execute --file prisma/migrate-existing-customers.sql --schema prisma/schema.prisma'"
          echo "‚úÖ Existing customers migrated to package schemes"

      - name: Deploy Agent Registration to Staging
        if: env.DEPLOY_AGENT_REGISTRATION != 'false'
        run: |
          # Retry deployment up to 3 times on failure
          for i in {1..3}; do
            echo "Deployment attempt $i..."
            if flyctl deploy -a maishapoa-staging-agent-registration -c infra/fly/agent-registration/staging/fly.toml; then
              echo "‚úÖ Deployment successful"
              break
            else
              if [ $i -lt 3 ]; then
                echo "‚ö†Ô∏è Deployment failed, retrying in 30 seconds..."
                sleep 30
              else
                echo "‚ùå Deployment failed after 3 attempts"
                exit 1
              fi
            fi
          done

      # TODO: Enable when web-admin app is created
      # - name: Deploy Web Admin to Staging
      #   run: |
      #     flyctl deploy -a microbima-staging-web-admin -c infra/fly/web-admin/staging/fly.toml

      - name: Deploy Public API to Staging
        if: env.DEPLOY_PUBLIC_API != 'false'
        run: |
          # Retry deployment up to 3 times on failure
          cd infra/fly/public-api/staging
          for i in {1..3}; do
            echo "Deployment attempt $i..."
            if flyctl deploy -a microbima-staging-public-api -c fly.toml; then
              echo "‚úÖ Deployment successful"
              break
            else
              if [ $i -lt 3 ]; then
                echo "‚ö†Ô∏è Deployment failed, retrying in 30 seconds..."
                sleep 30
              else
                echo "‚ùå Deployment failed after 3 attempts"
                exit 1
              fi
            fi
          done
          cd -

  deploy-production:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: https://maishapoa-production-internal-api.fly.dev
    env:
      DEPLOY_INTERNAL_API: true
      AUTO_DEPLOY_DB: true
      DEPLOY_AGENT_REGISTRATION: true
      DEPLOY_PUBLIC_API: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test

      - name: Install Fly.io CLI
        run: |
          curl -L https://fly.io/install.sh | sh
          echo "$HOME/.fly/bin" >> $GITHUB_PATH

      - name: Deploy Internal API to Production
        if: env.DEPLOY_INTERNAL_API != 'false'
        run: |
          # Retry deployment up to 3 times on failure
          for i in {1..3}; do
            echo "Deployment attempt $i..."
            if flyctl deploy -a maishapoa-production-internal-api -c infra/fly/internal-api/production/fly.toml; then
              echo "‚úÖ Deployment successful"
              break
            else
              if [ $i -lt 3 ]; then
                echo "‚ö†Ô∏è Deployment failed, retrying in 30 seconds..."
                sleep 30
              else
                echo "‚ùå Deployment failed after 3 attempts"
                exit 1
              fi
            fi
          done

      - name: Run Database Migrations on Production
        if: env.DEPLOY_INTERNAL_API != 'false' && env.AUTO_DEPLOY_DB == 'true'
        run: |
          echo "üîÑ Running database migrations on production..."
          
          # First, check if schemes table exists (needed for tags migration)
          echo "üîç Checking if schemes table exists..."
          set +e
          SCHEMES_CHECK=$(flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma db execute --stdin --schema prisma/schema.prisma <<< \"SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_schema = '\''public'\'' AND table_name = '\''schemes'\'');\"' 2>&1")
          set -e
          
          # Check migration status
          echo "üìä Checking migration status..."
          set +e
          MIGRATION_STATUS=$(flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate status 2>&1'")
          MIGRATION_EXIT_CODE=$?
          set -e
          
          # Proactively handle tags migration failure (known dependency issue)
          TAGS_MIGRATION_FAILED=false
          if echo "$MIGRATION_STATUS" | grep -q "20250202120000_add_tags_system.*failed\|P3018.*20250202120000\|relation.*schemes.*does not exist"; then
            TAGS_MIGRATION_FAILED=true
            echo "‚ö†Ô∏è Tags migration failed due to missing schemes table (dependency issue)"
            echo "üîß Resolving dependency by marking tags migration as rolled back..."
            
            # Mark tags migration as rolled back
            set +e
            flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate resolve --rolled-back 20250202120000_add_tags_system'"
            set -e
            
            echo "‚úÖ Tags migration marked as rolled back. Will be applied after schemes table is created."
          fi
          
          # Check for other failed migrations (P3009 error) - REQUIRE MANUAL INTERVENTION FOR PRODUCTION
          # But skip if it's only the tags migration (we handle that above)
          if [ "$MIGRATION_EXIT_CODE" != "0" ] || echo "$MIGRATION_STATUS" | grep -q "failed migrations\|P3009"; then
            # If it's only the tags migration, we've already handled it - proceed with migrations
            if [ "$TAGS_MIGRATION_FAILED" = "true" ] && ! echo "$MIGRATION_STATUS" | grep -q "failed migrations"; then
              echo "‚úÖ Only tags migration failed, already handled. Proceeding with other migrations..."
            else
              # Other failed migrations - require manual intervention
              echo "‚ö†Ô∏è Failed migrations detected in production."
              echo "‚ùå PRODUCTION SAFETY: Automated resolution is NOT available."
              echo "üìã Manual intervention REQUIRED before proceeding:"
              echo ""
              echo "   1. Connect to production:"
              echo "      flyctl ssh console -a maishapoa-production-internal-api"
              echo ""
              echo "   2. Check migration status:"
              echo "      cd /app/apps/api && npx prisma migrate status"
              echo ""
              echo "   3. Add missing enum value (if needed):"
              echo "      echo \"ALTER TYPE \\\"public\\\".\\\"PolicyStatus\\\" ADD VALUE IF NOT EXISTS 'PENDING_ACTIVATION';\" | npx prisma db execute --stdin --schema prisma/schema.prisma"
              echo ""
              echo "   4. Resolve failed migration:"
              echo "      npx prisma migrate resolve --rolled-back 20251030180217_add_package_plans_and_policy_payments"
              echo ""
              echo "   5. Mark enum migration as applied (if exists):"
              echo "      npx prisma migrate resolve --applied 20251030180216_add_pending_activation_enum 2>/dev/null || true"
              echo ""
              echo "   6. Verify status:"
              echo "      npx prisma migrate status"
              echo ""
              echo "   7. After manual resolution, retry deployment"
              echo ""
              exit 1
            fi
          elif echo "$MIGRATION_STATUS" | grep -q "drift"; then
            echo "‚ö†Ô∏è Drift detected in production."
            echo "‚ùå Automated drift resolution is not available for production safety."
            echo "üìã Manual intervention required:"
            echo "   1. Connect to production: flyctl ssh console -a maishapoa-production-internal-api"
            echo "   2. Check status: cd /app/apps/api && npx prisma migrate status"
            echo "   3. Resolve drift: npx prisma migrate resolve --applied [migration-name]"
            echo "   4. Retry deployment"
            exit 1
          else
            echo "‚úÖ No issues detected, running normal migration..."
          fi
          
          # Run migration deployment
          echo "üöÄ Deploying migrations to production..."
          flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate deploy'"
          
          # After migrations, if tags migration was rolled back, check if schemes table exists and reapply tags migration
          echo "üîç Checking if tags migration needs to be reapplied..."
          set +e
          SCHEMES_EXISTS=$(flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma db execute --stdin --schema prisma/schema.prisma <<< \"SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_schema = '\''public'\'' AND table_name = '\''schemes'\'');\"' 2>&1 | grep -o 'true\|false' | head -1")
          set -e
          
          if [ "$SCHEMES_EXISTS" = "true" ]; then
            echo "‚úÖ Schemes table exists. Checking if tags migration needs to be applied..."
            set +e
            TAGS_TABLE_EXISTS=$(flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma db execute --stdin --schema prisma/schema.prisma <<< \"SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_schema = '\''public'\'' AND table_name = '\''tags'\'');\"' 2>&1 | grep -o 'true\|false' | head -1")
            set -e
            
            if [ "$TAGS_TABLE_EXISTS" != "true" ]; then
              echo "üîß Applying tags migration now that schemes table exists..."
              flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && cat prisma/migrations/20250202120000_add_tags_system/migration.sql | npx prisma db execute --stdin --schema prisma/schema.prisma'"
              
              # Mark migration as applied
              flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate resolve --applied 20250202120000_add_tags_system'"
              echo "‚úÖ Tags migration applied and marked as resolved"
            else
              echo "‚úÖ Tags table already exists, marking migration as applied..."
              flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma migrate resolve --applied 20250202120000_add_tags_system 2>/dev/null || true'"
            fi
          fi
          
          echo "‚úÖ Database migrations completed"

      - name: Seed Product Management Data on Production
        if: env.DEPLOY_INTERNAL_API != 'false' && env.AUTO_DEPLOY_DB == 'true'
        run: |
          echo "üå± Seeding product management data on production..."
          echo "üìù Running idempotent seed script (safe to run multiple times)..."
          flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma db execute --file prisma/seed-product-management.sql --schema prisma/schema.prisma'"
          echo "‚úÖ Product management data seeded"
          
          # Migrate existing customers to package schemes (idempotent)
          echo "üîÑ Migrating existing customers to package schemes..."
          flyctl ssh console -a maishapoa-production-internal-api -C "sh -c 'cd /app/apps/api && npx prisma db execute --file prisma/migrate-existing-customers.sql --schema prisma/schema.prisma'"
          echo "‚úÖ Existing customers migrated to package schemes"

      - name: Deploy Agent Registration to Production
        if: env.DEPLOY_AGENT_REGISTRATION != 'false'
        run: |
          # Retry deployment up to 3 times on failure
          for i in {1..3}; do
            echo "Deployment attempt $i..."
            if flyctl deploy -a maishapoa-production-agent-registration -c infra/fly/agent-registration/production/fly.toml; then
              echo "‚úÖ Deployment successful"
              break
            else
              if [ $i -lt 3 ]; then
                echo "‚ö†Ô∏è Deployment failed, retrying in 30 seconds..."
                sleep 30
              else
                echo "‚ùå Deployment failed after 3 attempts"
                exit 1
              fi
            fi
          done

      - name: Deploy Public API to Production
        if: env.DEPLOY_PUBLIC_API != 'false'
        run: |
          # Retry deployment up to 3 times on failure
          cd infra/fly/public-api/production
          for i in {1..3}; do
            echo "Deployment attempt $i..."
            if flyctl deploy -a maishapoa-production-public-api -c fly.toml; then
              echo "‚úÖ Deployment successful"
              break
            else
              if [ $i -lt 3 ]; then
                echo "‚ö†Ô∏è Deployment failed, retrying in 30 seconds..."
                sleep 30
              else
                echo "‚ùå Deployment failed after 3 attempts"
                exit 1
              fi
            fi
          done
          cd -

      # TODO: Enable when web-admin app is created
      # - name: Deploy Web Admin to Production
      #   run: |
      #     flyctl deploy -a maishapoa-production-web-admin -c infra/fly/web-admin/production/fly.toml

  health-check:
    needs: [deploy-staging, deploy-production]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Health Check Staging
        if: github.ref == 'refs/heads/staging'
        run: |
          echo "üè• Running health checks for Staging environment..."
          
          # Agent Registration App
          echo "Checking Agent Registration..."
          curl -f https://maishapoa-staging-agent-registration.fly.dev/ || exit 1
          echo "‚úÖ Agent Registration is healthy"
          
          # Internal API (conditional check)
          if [ "$DEPLOY_INTERNAL_API" != "false" ]; then
            echo "Checking Internal API..."
            curl -f https://microbima-staging-internal-api.fly.dev/api/health || echo "‚ö†Ô∏è Internal API health check failed"
          else
            echo "‚è≠Ô∏è Skipping Internal API health check (not deployed)"
          fi
          
          # Public API (Kong Gateway) - check deployment status
          echo "Checking Public API..."
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://microbima-staging-public-api.fly.dev/api/v1/customers)
          echo "Public API status: $STATUS_CODE"
          
          if [ "$STATUS_CODE" -eq "200" ] || [ "$STATUS_CODE" -eq "401" ] || [ "$STATUS_CODE" -eq "403" ]; then
            echo "‚úÖ Public API is healthy and proxying correctly"
          elif [ "$STATUS_CODE" -eq "502" ] || [ "$STATUS_CODE" -eq "503" ]; then
            echo "‚ö†Ô∏è Public API deployed but backend connection issues (status $STATUS_CODE)"
            echo "   This is expected if backend is not deployed. Kong is running."
          else
            echo "‚ö†Ô∏è Public API returned status: $STATUS_CODE"
          fi
          
          # TODO: Add health check when web-admin app is deployed
          # curl -f https://microbima-staging-web-admin.fly.dev/ || exit 1
          
          echo "‚úÖ Staging health checks completed"

      - name: Health Check Production
        if: github.ref == 'refs/heads/master'
        run: |
          echo "üè• Running health checks for Production environment..."
          
          # Internal API
          echo "Checking Internal API..."
          curl -f https://maishapoa-production-internal-api.fly.dev/api/health || exit 1
          echo "‚úÖ Internal API is healthy"
          
          # Agent Registration App
          echo "Checking Agent Registration..."
          curl -f https://maishapoa-production-agent-registration.fly.dev/ || exit 1
          echo "‚úÖ Agent Registration is healthy"
          
          # Public API (Kong Gateway) - check deployment status
          echo "Checking Public API..."
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://maishapoa-production-public-api.fly.dev/api/v1/customers)
          echo "Public API status: $STATUS_CODE"
          
          if [ "$STATUS_CODE" -eq "200" ] || [ "$STATUS_CODE" -eq "401" ] || [ "$STATUS_CODE" -eq "403" ]; then
            echo "‚úÖ Public API is healthy and proxying correctly"
          elif [ "$STATUS_CODE" -eq "502" ] || [ "$STATUS_CODE" -eq "503" ]; then
            echo "‚ö†Ô∏è Public API deployed but backend connection issues (status $STATUS_CODE)"
            echo "   This is expected if backend is not deployed. Kong is running."
          else
            echo "‚ö†Ô∏è Public API returned status: $STATUS_CODE"
          fi
          
          # TODO: Add health check when web-admin app is deployed
          # curl -f https://maishapoa-production-web-admin.fly.dev/ || exit 1
          
          echo "‚úÖ All production health checks passed successfully"
