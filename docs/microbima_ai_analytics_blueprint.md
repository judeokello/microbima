# Microbima — AI IDE & Analytics Blueprint (Full Context)

> Save this file as **`docs/BLUEPRINT.md`** in the repo. Follow the file scaffolding below so **Cursor** can load project rules and contributors have a single source of truth.

---

## 0) How to use this blueprint

* **You SHOULD commit the files and contents below** (copy/paste the code blocks into the mentioned paths).
* **Cursor reads rules from** `.cursor/rules/*.md` (or root `.cursorrules`). The rest of this doc guides your repo layout, SDK generation, and analytics setup.
* Skim once, then execute **Section 5 — Task Checklist** step‑by‑step.

---

## 1) Repo‑level rules for Cursor (Project AI Instructions)

Create either:

* **`.cursor/rules/microbima.md`** *(preferred)*, or
* `.cursorrules` *(fallback at repo root)*

**Put this content in** `.cursor/rules/microbima.md`:

````md
# Microbima – Project Rules for AI (Cursor)

## Monorepo shape
- Single-root monorepo.
- Apps live in `apps/*` (e.g., `web-admin`, `mobile`, `api`).
- Shared code in `packages/*` (e.g., `sdk`, `ui`, `core`).
- Infra in `infra/*`.

## Source of truth for API contracts
- OpenAPI spec at `openapi/microbima.yaml` (or backend URL like `http://localhost:8000/openapi.json`).
- Always import request/response types from `@microbima/sdk`.
- Never use server-only/DB (Prisma) types in client code.

## Generated SDK
- Generate TS client + types with `openapi-typescript-codegen`.
- Output to `packages/sdk/src/gen`.
- Public entrypoint is `packages/sdk/src/index.ts`.
- Treat `src/gen` as **generated – do not edit**.

## Preferred imports
```ts
import { PoliciesService, type Policy } from "@microbima/sdk";
````

## AI suggestions & refactors

* When proposing API calls, prefer `@microbima/sdk` over ad‑hoc `fetch`.
* When adding endpoints, update OpenAPI → regenerate SDK.
* Avoid editing generated/ build folders: `**/.next`, `**/dist`, `**/.expo`, `**/.turbo`, `**/node_modules`.

## Conventions

* TypeScript strict; runtime validation with Zod where needed.
* React Query for data fetching in apps.
* Secrets via env vars only.

## Generated code policy

* We **commit** `packages/sdk/src/gen` for now to simplify app builds.

## Quick commands

* `pnpm sdk:gen` – generate SDK from OpenAPI.
* `pnpm sdk:build` – build SDK types.
* `pnpm dev` – run all apps via Turborepo.

```

---

## 2) Monorepo structure (baseline)
Create the following tree (empty dirs are fine initially):
```

microbima/
apps/
api/
web-admin/
mobile/
packages/
sdk/
ui/
core/
infra/
docker/
fly/
render/
openapi/
microbima.yaml           # temporary stub if not generated by backend
docs/
BLUEPRINT.md             # this file
.gitignore
package.json
pnpm-workspace.yaml
tsconfig.base.json

````

**`.gitignore` (root)**
```gitignore
node_modules/
**/.next/
**/.expo/
**/.turbo/
**/dist/
**/build/
**/.env*
packages/sdk/src/gen/
````

**`pnpm-workspace.yaml` (root)**

```yaml
packages:
  - "apps/*"
  - "packages/*"
```

**`tsconfig.base.json` (root)**

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "strict": true,
    "skipLibCheck": true,
    "esModuleInterop": true,
    "resolveJsonModule": true,
    "baseUrl": ".",
    "paths": {
      "@microbima/sdk": ["packages/sdk/src"]
    }
  }
}
```

**`package.json` (root)**

```json
{
  "name": "microbima",
  "private": true,
  "workspaces": ["apps/*", "packages/*"],
  "scripts": {
    "sdk:gen": "pnpm --filter @microbima/sdk generate",
    "sdk:build": "pnpm --filter @microbima/sdk build",
    "dev": "turbo run dev"
  },
  "devDependencies": {
    "turbo": "^2.1.0",
    "typescript": "^5.5.0"
  }
}
```

---

## 3) Contract‑first SDK (OpenAPI → TypeScript client)

If your backend already serves OpenAPI (e.g., FastAPI `/openapi.json`, NestJS `/api-json`), you can point the generator to that URL. Otherwise, keep a spec file at `openapi/microbima.yaml`.

**Create** `packages/sdk/package.json`:

```json
{
  "name": "@microbima/sdk",
  "version": "0.1.0",
  "private": true,
  "type": "module",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "files": ["dist", "src"],
  "scripts": {
    "clean": "rimraf dist src/gen",
    "generate": "openapi --input ../../openapi/microbima.yaml --output src/gen --client fetch",
    "build": "tsc -p tsconfig.json && cp -r src/gen dist"
  },
  "devDependencies": {
    "openapi-typescript-codegen": "^0.29.0",
    "rimraf": "^6.0.0",
    "typescript": "^5.5.0"
  }
}
```

**Create** `packages/sdk/tsconfig.json`:

```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "outDir": "dist",
    "declaration": true,
    "emitDeclarationOnly": true,
    "skipLibCheck": true
  },
  "include": ["src/**/*"]
}
```

**Create** `packages/sdk/src/index.ts`:

```ts
export * from "./gen";

export function withAuth(token: string) {
  return {
    WITH_CREDENTIALS: false,
    TOKEN: token,
    interceptors: {
      request: (url: string, init: RequestInit) => {
        const headers = new Headers(init.headers || {});
        if (token) headers.set("Authorization", `Bearer ${token}`);
        return { url, init: { ...init, headers } };
      }
    }
  } as const;
}
```

**If using a URL instead of file** (e.g., `http://localhost:8000/openapi.json`), change the `generate` script in `packages/sdk/package.json` to:

```json
"generate": "openapi --input http://localhost:8000/openapi.json --output src/gen --client fetch"
```

**Optional OpenAPI stub** `openapi/microbima.yaml` (replace with your real spec):

```yaml
openapi: 3.0.3
info:
  title: Microbima API
  version: 0.1.0
servers:
  - url: http://localhost:8000
paths:
  /policies:
    get:
      operationId: getPolicies
      responses:
        '200':
          description: list policies
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Policy'
components:
  schemas:
    Policy:
      type: object
      properties:
        id: { type: string }
        product: { type: string }
        status: { type: string }
```

**Usage example (in `apps/web-admin`)**

```ts
import { PoliciesService, withAuth } from "@microbima/sdk";

const cfg = withAuth(localStorage.getItem("token") || "");
export async function listPolicies() {
  return PoliciesService.getPolicies({}, cfg as any);
}
```

> Keep **Prisma/DB types** server-side only (e.g., `packages/db`). Clients only import `@microbima/sdk` types.

---

## 4) Analytics Stack (PostHog + Metabase)

### Goals

* **PostHog**: product analytics (events, funnels, cohorts), feature flags, session replay.
* **Metabase**: business/BI dashboards over PostgreSQL (read‑only connection).

### 4.1 PostHog

**Web (Next.js) init** – `apps/web-admin/src/lib/posthog.ts`:

```ts
import posthog from "posthog-js";

export function initPostHog() {
  if (typeof window === "undefined") return;
  if (posthog.__loaded) return;
  posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY!, {
    api_host: process.env.NEXT_PUBLIC_POSTHOG_HOST,
    capture_pageview: true,
    capture_pageleave: true
  });
}

export const capture = (event: string, props?: Record<string, any>) =>
  posthog.capture(event, props);
```

Use in `_app.tsx` or `layout.tsx`:

```ts
useEffect(() => initPostHog(), []);
```

**React Native** – `apps/mobile/src/analytics/posthog.ts`:

```ts
import PostHog from "posthog-react-native";
export const posthog = new PostHog(process.env.EXPO_PUBLIC_POSTHOG_KEY!, {
  host: process.env.EXPO_PUBLIC_POSTHOG_HOST
});
export const capture = (e: string, p?: Record<string, any>) => posthog.capture(e, p);
```

**Server events** – `apps/api/src/analytics/posthog.ts`:

```ts
import { PostHog } from "posthog-node";
export const ph = new PostHog(process.env.POSTHOG_KEY!, { host: process.env.POSTHOG_HOST });
// await ph.capture({ distinctId: userId, event: "policy.issued", properties: { policyId } });
```

**Event naming**

* Use `domain.action` (e.g., `policy.issued`, `claim.submitted`, `payment.failed`).
* Maintain `analytics/README.md` with taxonomy and PII policy.

**analytics/README.md**

```md
# Analytics
- Tooling: PostHog (product), Metabase (BI).
- Event naming: `domain.action`.
- Identity: `distinct_id` = user UUID; use `group` for organization/group.
- PII: avoid raw PII in names/properties; hash or tokenise where necessary.
```

**Env examples** (root `.env.example`)

```env
NEXT_PUBLIC_POSTHOG_KEY=phc_xxx
NEXT_PUBLIC_POSTHOG_HOST=https://app.posthog.com
POSTHOG_KEY=phx_xxx
POSTHOG_HOST=https://app.posthog.com
```

### 4.2 Metabase

Deploy via Docker (metadata DB with Postgres). Create `infra/docker/metabase-compose.yaml`:

```yaml
version: "3.9"
services:
  metabase:
    image: metabase/metabase:latest
    ports: ["3001:3000"]
    environment:
      MB_DB_TYPE: postgres
      MB_DB_HOST: metabase-db
      MB_DB_PORT: 5432
      MB_DB_DBNAME: metabase
      MB_DB_USER: metabase
      MB_DB_PASS: metabase
    depends_on: [metabase-db]
  metabase-db:
    image: postgres:16
    environment:
      POSTGRES_DB: metabase
      POSTGRES_USER: metabase
      POSTGRES_PASSWORD: metabase
    volumes:
      - metabase_db:/var/lib/postgresql/data
volumes:
  metabase_db:
```

Run: `docker compose -f infra/docker/metabase-compose.yaml up -d`

Then, in the Metabase UI, add your **operational PostgreSQL** as a **data source** using a **read-only DB user**.

**Read-only DB user (example SQL)**

```sql
CREATE ROLE metabase_ro LOGIN PASSWORD 'strong_password';
GRANT CONNECT ON DATABASE microbima TO metabase_ro;
GRANT USAGE ON SCHEMA public TO metabase_ro;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO metabase_ro;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO metabase_ro;
```

**Starter dashboards**

* Ops: Active policies, claims TAT, open claims.
* Finance: Premiums by product, MRR, arrears, recoveries.
* Product: Conversion funnel, feature adoption, churn.

> Keep data‑minimization by default. No raw PII in chart labels. Use role‑based Metabase collections.

---

## 5) Task Checklist (Do these in order)

1. **Create repo layout** (Section 2). Commit `.gitignore`, `pnpm-workspace.yaml`, `tsconfig.base.json`, root `package.json`.
2. **Add Cursor rules** (Section 1): create `.cursor/rules/microbima.md` with the provided content.
3. **Scaffold SDK** (Section 3): add `packages/sdk/*` files.
4. **Add OpenAPI**: either place `openapi/microbima.yaml` or expose the backend OpenAPI URL and update `packages/sdk/package.json` `generate` script accordingly.
5. **Install deps & generate**:

   ```bash
   pnpm i
   pnpm sdk:gen
   pnpm sdk:build
   git add -A && git commit -m "chore: scaffold sdk and cursor rules"
   ```
6. **Wire SDK in apps**: replace ad‑hoc fetch with imports from `@microbima/sdk`.
7. **Analytics** (Section 4):

   * Add PostHog init in `web-admin` and `mobile`.
   * Add server capture in `api`.
   * Create `analytics/README.md` and `env` variables.
8. **Metabase**: bring up Docker compose, connect read‑only Postgres, create 3 starter dashboards.
9. **Protect secrets**: ensure `.env*` files are git‑ignored and CI secrets are set in your platform (Render/Fly/etc.).
10. **ADR records** (Section 6): add ADRs into `docs/adr/*`.

---

## 6) ADRs (Architecture Decision Records)

Create `docs/adr/0001-contract-first-sdk.md`:

```md
# ADR-0001: Contract-first SDK
- Decision: OpenAPI is the API contract; generate `@microbima/sdk` with `openapi-typescript-codegen`.
- Rationale: Single source of truth; eliminate drift; shared types across apps.
- Consequences: Keep spec updated; commit generated code for now; revisit CI generation later.
```

Create `docs/adr/0002-analytics-stack.md`:

```md
# ADR-0002: Analytics Stack
- Decision: PostHog for product analytics/flags/replay; Metabase for BI over PostgreSQL (read-only user).
- Rationale: Fast time-to-value, OSS-friendly, separation of concerns.
- Consequences: Maintain event taxonomy; enforce PII minimization; secure read-only DB role.
```

---

## 7) Nice‑to‑have extras (later)

* **.code-workspace** for multi-root if you split repos.
* **CI job** to validate OpenAPI (Spectral) and fail PRs on contract drift.
* **Mock server** from OpenAPI for local dev (e.g., Prism/Orval).
* **Feature flag discipline**: tie high‑risk features to PostHog flags.

---

**Done!** Commit these files and open the repo in Cursor. The rules file will steer the AI to: respect OpenAPI as the contract, generate/consume the SDK correctly, avoid Prisma types in clients, and keep analytics consistent across apps.
