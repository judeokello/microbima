// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

/// @seed="npx ts-node prisma/seed.ts"

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Partner {
  id             Int     @id @default(autoincrement())
  partnerName    String
  website        String?
  officeLocation String?
  isActive       Boolean @default(true)

  // Relations
  partnerContacts        PartnerContact[]
  partnerCustomers       PartnerCustomer[]
  partnerApiKeys         PartnerApiKey[]
  packageSchemeCustomers PackageSchemeCustomer[]

  // Agent Registration relations
  brandAmbassadors    BrandAmbassador[]
  registrations       AgentRegistration[]
  missingRequirements MissingRequirement[]
  deferredPartner     DeferredRequirementPartner[]
  baPayouts           BAPayout[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // User ID who created
  updatedBy String? // User ID who last updated

  @@map("partners")
}

model PartnerApiKey {
  id        Int     @id @default(autoincrement())
  partnerId Int
  partner   Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  apiKey    String // SHA-256 hashed API key
  isActive  Boolean @default(true)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([partnerId, isActive], name: "unique_active_key_per_partner") // Only one active key per partner
  @@index([apiKey], name: "idx_api_key_lookup") // For fast API key lookups
  @@map("partner_api_keys")
}

model PartnerContact {
  id        Int     @id @default(autoincrement())
  partnerId Int
  partner   Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  contactName  String
  contactPhone String  @db.VarChar(20) // Numeric phone number, max 20 characters
  contactEmail String?
  isPrimary    Boolean @default(false)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("partner_contacts")
}

model PartnerCustomer {
  id                Int      @id @default(autoincrement())
  partnerId         Int
  partner           Partner  @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  customerId        String   @db.Uuid
  customer          Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  partnerCustomerId String // External partner customer ID (unique per partner)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([partnerId, partnerCustomerId]) // Unique combination of partner and partnerCustomerId
  @@map("partner_customers")
}

model Customer {
  id                     String         @id @default(uuid()) @db.Uuid
  firstName              String         @db.VarChar(50)
  middleName             String?        @db.VarChar(50) // Optional middle name
  lastName               String         @db.VarChar(50)
  email                  String?        @unique // Made nullable - when provided must be unique
  phoneNumber            String         @db.VarChar(20) // Numeric phone number, max 20 characters
  dateOfBirth            DateTime?      @db.Date // Date only, no time component
  gender                 Gender? // Optional gender field
  idType                 IdType
  idNumber               String         @db.VarChar(20) // Max 20 characters
  status                 CustomerStatus @default(PENDING_KYC)
  onboardingStep         OnboardingStep @default(BASIC_INFO)
  createdByPartnerId     Int // Partner who created this customer
  hasMissingRequirements Boolean        @default(false)

  // Address information
  address Address?

  // Dependants
  dependants Dependant[]

  // Beneficiaries
  beneficiaries Beneficiary[]

  // Onboarding progress
  onboardingProgress OnboardingProgress?

  // KYC information
  kycVerification KYCVerification?

  // Policies
  policies Policy[]

  // Relations
  partnerCustomers       PartnerCustomer[]
  packageSchemeCustomers PackageSchemeCustomer[]

  // Agent Registration relations
  registrations       AgentRegistration[]
  missingRequirements MissingRequirement[]

  // Policy member relations
  policyMemberPrincipals PolicyMemberPrincipal[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // User ID who created
  updatedBy String? // User ID who last updated

  @@unique([idType, idNumber], name: "unique_id_type_number") // Unique combination of idType and idNumber
  @@map("customers")
}

model Address {
  id         Int      @id @default(autoincrement())
  customerId String   @unique @db.Uuid
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  street     String
  city       String
  state      String
  postalCode String
  country    String @default("KE") // Default to Kenya

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("addresses")
}

model Dependant {
  id         String   @id @default(uuid()) @db.Uuid
  customerId String   @db.Uuid
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  firstName          String                @db.VarChar(50)
  middleName         String?               @db.VarChar(50) // Optional middle name
  lastName           String                @db.VarChar(50)
  dateOfBirth        DateTime?             @db.Date // Optional date of birth, date only
  gender             Gender? // Optional gender field
  email              String?               @db.VarChar(100) // Optional email
  phoneNumber        String?               @db.VarChar(20) // Optional phone number
  idType             IdType? // Optional ID type for identification
  idNumber           String?               @db.VarChar(20) // Optional ID number for identification, max 20 characters
  relationship       DependantRelationship
  isVerified         Boolean               @default(false) // Verification status
  verifiedAt         DateTime? // When verification was completed
  verifiedBy         String?               @db.Uuid // Who verified (user ID)
  verificationRequired Boolean             @default(false) // Verification required for children 18-24 years old
  createdByPartnerId Int // Partner who created this dependant

  // Policy member relations
  policyMemberDependants PolicyMemberDependant[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("dependants")
}

model Beneficiary {
  id         String   @id @default(uuid()) @db.Uuid
  customerId String   @db.Uuid
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  firstName               String    @db.VarChar(50)
  middleName              String?   @db.VarChar(50) // Optional field
  lastName                String    @db.VarChar(50)
  dateOfBirth             DateTime? @db.Date // Optional date of birth, date only
  gender                  Gender? // Optional field
  email                   String?   @db.VarChar(100) // Optional email
  phoneNumber             String?   @db.VarChar(20) // Optional phone number
  idType                  IdType?
  idNumber                String?   @db.VarChar(20) // Max 20 characters
  relationship            String? // Relationship to principal member
  relationshipDescription String? // Optional description for "other" relationship
  percentage              Int? // Percentage of benefits (1-100)
  isVerified              Boolean   @default(false) // Verification status
  verifiedAt              DateTime? // When verification was completed
  verifiedBy              String?   @db.Uuid // Who verified (user ID)
  createdByPartnerId      Int // Partner who created this beneficiary

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("beneficiaries")
}

model OnboardingProgress {
  id         Int      @id @default(autoincrement())
  customerId String   @unique @db.Uuid
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  currentStep         OnboardingStep
  completedSteps      OnboardingStep[]
  nextStep            OnboardingStep?
  estimatedCompletion DateTime?

  // Step-specific data
  basicInfoCompleted    Boolean @default(false)
  kycCompleted          Boolean @default(false)
  planSelected          Boolean @default(false)
  paymentSetupCompleted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("onboarding_progress")
}

model KYCVerification {
  id         Int      @id @default(autoincrement())
  customerId String   @unique @db.Uuid
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  status             KYCStatus             @default(PENDING)
  verificationMethod KYCVerificationMethod
  documents          Json? // Array of document references
  verifiedAt         DateTime?
  verifiedBy         String? // User ID who verified

  // KYC provider response
  providerReference String?
  providerResponse  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("kyc_verifications")
}

model Policy {
  id              String       @id @default(uuid()) @db.Uuid
  policyNumber    String?      @unique
  status          PolicyStatus @default(PENDING_ACTIVATION)
  customerId      String       @db.Uuid
  packageId       Int
  packagePlanId   Int?
  paymentAcNumber String?      @unique @db.VarChar(50)

  productName    String
  startDate      DateTime?
  endDate        DateTime?
  premium        Decimal          @db.Decimal(10, 2)
  frequency      PaymentFrequency
  paymentCadence Int // Number of days between premium payments

  // Relations
  customer       Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)
  package        Package         @relation(fields: [packageId], references: [id], onDelete: Restrict)
  packagePlan    PackagePlan?    @relation(fields: [packagePlanId], references: [id], onDelete: Restrict)
  policyPayments PolicyPayment[]
  policyTags     PolicyTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("policies")
}

enum CustomerStatus {
  PENDING_KYC
  PENDING_ACTIVATION
  KYC_VERIFIED
  ACTIVE
  SUSPENDED
  TERMINATED
}

enum OnboardingStep {
  BASIC_INFO
  KYC_VERIFICATION
  PLAN_SELECTION
  PAYMENT_SETUP
  ACTIVE
}

enum IdType {
  NATIONAL_ID
  PASSPORT
  ALIEN
  BIRTH_CERTIFICATE
  MILITARY
}

enum DependantRelationship {
  SPOUSE
  CHILD
  PARENT
  SIBLING
  FRIEND
  OTHER
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum KYCStatus {
  PENDING
  IN_PROGRESS
  VERIFIED
  REJECTED
  EXPIRED
}

enum KYCVerificationMethod {
  MANUAL
  AUTOMATED
  THIRD_PARTY
}

enum PolicyStatus {
  PENDING_ACTIVATION
  ACTIVE
  SUSPENDED
  TERMINATED
  EXPIRED
}

enum PaymentFrequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUALLY
  CUSTOM
}

enum PaymentType {
  MPESA
  SASAPAY
}

// New enums for Agent Registration module
enum RegistrationEntityKind {
  CUSTOMER
  SPOUSE
  CHILD
  BENEFICIARY
}

enum RegistrationStatus {
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum RegistrationMissingStatus {
  PENDING
  RESOLVED
  EXPIRED
}

enum BAPayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum MpesaStatementReasonType {
  PayBill_STK
  Ratiba
  Paybill_MobileApp
  PayBill_Fuliza_STK
  PayBill_Fuliza_Online
  Withdrawal
  Unmapped
}

enum MpesaPaymentSource {
  IPN
  STATEMENT
}

enum MpesaStkPushStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  EXPIRED
}

// Agent Registration Models
model BrandAmbassador {
  id        String  @id @default(uuid()) @db.Uuid
  userId    String  @unique @db.Uuid // Supabase user ID
  partnerId Int
  partner   Partner @relation(fields: [partnerId], references: [id])

  displayName              String
  phoneNumber              String? @db.VarChar(20)
  perRegistrationRateCents Int // Rate in cents (e.g., 500 = 5.00 KES)
  isActive                 Boolean @default(true)

  // Relations
  registrations AgentRegistration[]
  payouts       BAPayout[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // User ID who created
  updatedBy String? // User ID who last updated

  @@map("brand_ambassadors")
}

model AgentRegistration {
  id         String @id @default(uuid()) @db.Uuid
  baId       String @db.Uuid
  customerId String @db.Uuid
  partnerId  Int

  ba       BrandAmbassador @relation(fields: [baId], references: [id])
  customer Customer        @relation(fields: [customerId], references: [id])
  partner  Partner         @relation(fields: [partnerId], references: [id])

  registrationStatus RegistrationStatus @default(IN_PROGRESS)
  completedAt        DateTime?

  // Relations
  missingRequirements MissingRequirement[]
  payouts             BAPayout[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("agent_registrations")
}

model MissingRequirement {
  id             String @id @default(uuid()) @db.Uuid
  registrationId String @db.Uuid
  customerId     String @db.Uuid
  partnerId      Int

  entityKind RegistrationEntityKind
  entityId   String? // ID of spouse/child/beneficiary if applicable
  fieldPath  String // e.g., "firstName", "gender", "idNumber"
  status     RegistrationMissingStatus @default(PENDING)

  registration AgentRegistration @relation(fields: [registrationId], references: [id])
  customer     Customer          @relation(fields: [customerId], references: [id])
  partner      Partner           @relation(fields: [partnerId], references: [id])

  resolvedAt DateTime?
  resolvedBy String? // User ID who resolved

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("missing_requirements")
}

model BAPayout {
  id             String  @id @default(uuid()) @db.Uuid
  baId           String  @db.Uuid
  registrationId String? @db.Uuid // Optional - can be general payout
  partnerId      Int

  amountCents Int // Amount in cents
  status      BAPayoutStatus @default(PENDING)
  payoutDate  DateTime?
  reference   String? // Payment reference

  ba           BrandAmbassador    @relation(fields: [baId], references: [id])
  registration AgentRegistration? @relation(fields: [registrationId], references: [id])
  partner      Partner            @relation(fields: [partnerId], references: [id])

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ba_payouts")
}

model DeferredRequirementDefault {
  id         Int                    @id @default(autoincrement())
  entityKind RegistrationEntityKind
  fieldPath  String
  isRequired Boolean                @default(true)

  @@unique([entityKind, fieldPath])
  @@map("deferred_requirements_default")
}

model DeferredRequirementPartner {
  id         Int                    @id @default(autoincrement())
  partnerId  Int
  entityKind RegistrationEntityKind
  fieldPath  String
  isRequired Boolean                @default(true)

  partner Partner @relation(fields: [partnerId], references: [id])

  @@unique([partnerId, entityKind, fieldPath])
  @@map("deferred_requirements_partner")
}

// Product Management Models
model Underwriter {
  id             Int     @id @default(autoincrement())
  name           String  @db.VarChar(100)
  shortName      String  @db.VarChar(50)
  website        String  @db.VarChar(100)
  officeLocation String  @db.VarChar(200)
  isActive       Boolean @default(true)
  logoPath       String? @db.VarChar(200)

  // Relations
  packages Package[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String // User ID who created

  @@map("underwriters")
}

model Package {
  id                 Int     @id @default(autoincrement())
  name               String  @db.VarChar(100)
  description        String  @db.VarChar(500)
  underwriterId      Int?
  isActive           Boolean @default(true)
  policyNumberFormat String? @db.VarChar(200)
  memberNumberFormat String? @db.VarChar(200)
  logoPath           String? @db.VarChar(200)
  cardTemplateName   String? @db.VarChar(100)

  // Relations
  underwriter     Underwriter?     @relation(fields: [underwriterId], references: [id])
  packageProducts PackageProduct[]
  packageSchemes  PackageScheme[]
  packagePlans    PackagePlan[]
  policies        Policy[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String // User ID who created

  @@map("packages")
}

model ProductType {
  id          Int     @id @default(autoincrement())
  name        String  @db.VarChar(100)
  description String? @db.VarChar(300)

  // Relations
  products Product[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("product_types")
}

model Product {
  id            Int    @id @default(autoincrement())
  productTypeId Int
  productName   String @db.VarChar(200)
  description   String @db.VarChar(500)

  // Relations
  productType     ProductType      @relation(fields: [productTypeId], references: [id])
  packageProducts PackageProduct[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("products")
}

model PackageProduct {
  id        Int @id @default(autoincrement())
  packageId Int
  productId Int

  // Relations
  package Package @relation(fields: [packageId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  // Audit fields
  createdAt DateTime @default(now())

  @@unique([packageId, productId])
  @@map("package_products")
}

model Scheme {
  id          Int     @id @default(autoincrement())
  schemeName  String  @db.VarChar(100)
  description String  @db.VarChar(300)
  isActive    Boolean @default(true)

  // Postpaid scheme fields
  isPostpaid      Boolean           @default(false)
  frequency       PaymentFrequency?
  paymentCadence  Int?
  paymentAcNumber String?           @unique @db.VarChar(50)

  // Relations
  packageSchemes PackageScheme[]
  schemeTags     SchemeTag[]
  schemeContacts SchemeContact[]

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String // User ID who created

  @@map("schemes")
}

model PackageScheme {
  id        Int @id @default(autoincrement())
  packageId Int
  schemeId  Int

  // Relations
  package                Package                 @relation(fields: [packageId], references: [id])
  scheme                 Scheme                  @relation(fields: [schemeId], references: [id])
  packageSchemeCustomers PackageSchemeCustomer[]

  // Audit fields
  createdAt DateTime @default(now())

  @@unique([packageId, schemeId])
  @@map("package_schemes")
}

model PackageSchemeCustomer {
  id                Int     @id @default(autoincrement())
  packageSchemeId   Int
  partnerId         Int?
  customerId        String  @db.Uuid
  partnerCustomerId String?

  // Relations
  packageScheme PackageScheme @relation(fields: [packageSchemeId], references: [id])
  partner       Partner?      @relation(fields: [partnerId], references: [id])
  customer      Customer      @relation(fields: [customerId], references: [id])

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("package_scheme_customers")
}

model PackagePlan {
  id          Int     @id @default(autoincrement())
  name        String  @db.VarChar(200)
  description String? @db.VarChar(200)
  packageId   Int
  isActive    Boolean @default(true)

  // Relations
  package  Package  @relation(fields: [packageId], references: [id])
  policies Policy[]

  // Audit fields
  createdAt DateTime @default(now())
  createdBy String   @db.Uuid
  updatedAt DateTime @updatedAt
  updatedBy String   @db.Uuid

  @@unique([packageId, name])
  @@map("package_plans")
}

model PolicyMemberPrincipal {
  id           Int    @id @default(autoincrement())
  customerId   String @db.Uuid
  memberNumber String @db.VarChar(50)

  // Relations
  customer Customer @relation(fields: [customerId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime?

  @@map("policy_member_principals")
}

model PolicyMemberDependant {
  id           Int    @id @default(autoincrement())
  dependantId  String @db.Uuid
  memberNumber String @db.VarChar(50)

  // Relations
  dependant Dependant @relation(fields: [dependantId], references: [id])

  createdAt DateTime  @default(now())
  updatedAt DateTime?

  @@map("policy_member_dependants")
}

model PolicyPayment {
  id                   Int         @id @default(autoincrement())
  policyId             String      @db.Uuid
  paymentType          PaymentType
  transactionReference String      @db.VarChar(50)
  amount               Decimal     @db.Decimal(10, 2)
  accountNumber        String?     @db.VarChar(50)
  details              String?     @db.VarChar(500)
  expectedPaymentDate  DateTime
  actualPaymentDate    DateTime?
  paymentMessageBlob   String?     @db.VarChar(500)

  // Relations
  policy Policy @relation(fields: [policyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("policy_payments")
}

model Tag {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(100)

  // Relations
  schemeTags SchemeTag[]
  policyTags PolicyTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tags")
}

model SchemeTag {
  id       Int @id @default(autoincrement())
  schemeId Int
  tagId    Int

  // Relations
  scheme Scheme @relation(fields: [schemeId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([schemeId, tagId])
  @@map("scheme_tags")
}

model PolicyTag {
  id       Int    @id @default(autoincrement())
  policyId String @db.Uuid
  tagId    Int

  // Relations
  policy Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([policyId, tagId])
  @@map("policy_tags")
}

model MpesaPaymentReportUpload {
  id               String    @id @default(uuid()) @db.Uuid
  accountHolder    String    @db.VarChar(100)
  shortCode        String?   @db.VarChar(100)
  account          String?   @db.VarChar(50)
  timeFrom         DateTime
  timeTo           DateTime
  operator         String?   @db.VarChar(100)
  reportDate       DateTime? // Date of Report from Row 5, column F
  openingBalance   Decimal?  @db.Decimal(10, 2)
  closingBalance   Decimal?  @db.Decimal(10, 2)
  availableBalance Decimal?  @db.Decimal(10, 2)
  totalPaidIn      Decimal?  @db.Decimal(10, 2)
  totalWithdrawn   Decimal?  @db.Decimal(10, 2)
  filePath         String?   @db.VarChar(500) // Storage path for the uploaded file

  // Relations
  items MpesaPaymentReportItem[]

  // Audit fields
  createdBy String? // User ID who created
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("mpesa_payment_report_uploads")
}

model MpesaPaymentReportItem {
  id                        String                    @id @default(uuid()) @db.Uuid
  mpesaPaymentReportUploadId String?                  @db.Uuid // Made nullable for IPN records
  transactionReference      String                    @db.VarChar(50)
  completionTime            DateTime
  initiationTime         DateTime
  paymentDetails            String?                   @db.VarChar(500)
  transactionStatus        String?                   @db.VarChar(100)
  paidIn                   Decimal                   @db.Decimal(10, 2)
  withdrawn                Decimal                   @db.Decimal(10, 2)
  accountBalance           Decimal                   @db.Decimal(10, 2)
  balanceConfirmed         String?                   @db.VarChar(20)
  reasonType               MpesaStatementReasonType
  otherPartyInfo           String?                   @db.VarChar(500)
  linkedTransactionId      String?                   @db.VarChar(100)
  accountNumber             String?                   @db.VarChar(100)
  isProcessed               Boolean                   @default(false)
  isMapped                  Boolean                   @default(false)

  // New fields for IPN and STK Push integration
  msisdn                    String?                   @db.VarChar(20) // Customer phone number (normalized: 254XXXXXXXXX)
  firstName                 String?                   @db.VarChar(100) // Customer first name from IPN
  middleName                String?                   @db.VarChar(100) // Customer middle name from IPN
  lastName                  String?                   @db.VarChar(100) // Customer last name from IPN
  source                    MpesaPaymentSource        @default(IPN) // Data source (IPN or STATEMENT)
  businessShortCode         String?                   @db.VarChar(20) // Business short code from IPN
  mpesaStkPushRequestId     String?                   @unique @db.Uuid // Link to STK Push request (unique for one-to-one relation)

  // Relations
  mpesaPaymentReportUpload MpesaPaymentReportUpload? @relation(fields: [mpesaPaymentReportUploadId], references: [id], onDelete: Cascade)
  mpesaStkPushRequest      MpesaStkPushRequest?      @relation(fields: [mpesaStkPushRequestId], references: [id], onDelete: SetNull)

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([transactionReference], name: "idx_transaction_reference")
  @@index([mpesaPaymentReportUploadId], name: "idx_mpesa_payment_report_upload_id")
  @@index([transactionReference, source], name: "idx_transaction_reference_source") // Composite index for deduplication
  @@index([source], name: "idx_source") // For filtering by source
  @@index([accountNumber], name: "idx_account_number") // For matching with STK Push requests
  @@map("mpesa_payment_report_items")
}

model MpesaStkPushRequest {
  id                String            @id @default(uuid()) @db.Uuid // Auto-generated UUID, used as MerchantRequestID
  checkoutRequestId String?           @db.VarChar(100) // From Daraja STK Push response (CheckoutRequestID)
  phoneNumber       String            @db.VarChar(20) // Customer phone number (normalized: 254XXXXXXXXX)
  amount            Decimal           @db.Decimal(10, 2) // Transaction amount (1-70,000 KES)
  accountReference  String            @db.VarChar(100) // Policy payment account number (BillRefNumber)
  transactionDesc   String?           @db.VarChar(500) // Transaction description
  status            MpesaStkPushStatus @default(PENDING) // Request status (latest status from callbacks)
  resultCode        String?           @db.VarChar(10) // Latest result code from STK Push callback
  resultDesc        String?           @db.VarChar(500) // Latest result description from STK Push callback
  linkedTransactionId String?        @db.VarChar(100) // TransID from IPN (when linked)
  initiatedBy       String?          // Agent/user ID who initiated
  initiatedAt       DateTime          @default(now()) // When STK Push was initiated
  completedAt       DateTime?        // When transaction completed
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  transaction MpesaPaymentReportItem? // One-to-one, nullable (linked payment record)
  callbackResponses MpesaStkPushCallbackResponse[] // All callback responses for this request

  @@unique([checkoutRequestId]) // Unique checkout request ID (for callback lookup)
  @@index([accountReference]) // For matching with IPN BillRefNumber
  @@index([status, createdAt]) // For querying pending requests
  @@index([phoneNumber]) // For matching with IPN MSISDN
  @@map("mpesa_stk_push_requests")
}

/**
 * STK Push Callback Response
 * 
 * Stores STK Push callback responses from M-Pesa for audit purposes.
 * M-Pesa sends exactly one callback per STK Push request with a final ResultCode.
 * Multiple records may exist only if M-Pesa retries sending the same callback
 * (with the same ResultCode) if our endpoint doesn't respond correctly.
 * This provides a complete audit trail of callback deliveries.
 */
model MpesaStkPushCallbackResponse {
  id                  String   @id @default(uuid()) @db.Uuid
  mpesaStkPushRequestId String @db.Uuid // Foreign key to STK Push request
  resultCode          Int      // M-Pesa result code (0 = success, non-zero = error/failure)
  resultDesc          String   @db.VarChar(500) // Result description from M-Pesa
  callbackMetadata    String?  @db.Text // JSON string of CallbackMetadata (if available)
  receivedAt          DateTime @default(now()) // When this callback was received
  createdAt           DateTime @default(now())

  // Relations
  mpesaStkPushRequest MpesaStkPushRequest @relation(fields: [mpesaStkPushRequestId], references: [id], onDelete: Cascade)

  @@index([mpesaStkPushRequestId]) // For querying all responses for a request
  @@index([resultCode]) // For filtering by result code
  @@index([receivedAt]) // For querying by time
  @@map("mpesa_stk_push_callback_responses")
}

model SchemeContact {
  id           Int     @id @default(autoincrement())
  schemeId     Int
  firstName    String  @db.VarChar(50)
  otherName    String? @db.VarChar(50)
  phoneNumber  String? @db.VarChar(15)
  phoneNumber2 String? @db.VarChar(15)
  email        String? @db.VarChar(100)
  designation  String? @db.VarChar(100)
  notes        String? @db.VarChar(500)

  // Relations
  scheme Scheme @relation(fields: [schemeId], references: [id], onDelete: Cascade)

  // Audit fields
  createdAt DateTime  @default(now())
  createdBy String    @db.Uuid
  updatedAt DateTime? @updatedAt

  @@map("scheme_contacts")
}

model PaymentAccountNumberSequence {
  id            Int      @id @default(1)
  currentValue  Int      @default(221)
  lastUpdatedAt DateTime @default(now()) @updatedAt

  @@map("payment_account_number_sequences")
}
